{% extends "base.html" %}

{% block title %}é›»è¡¨å³æ™‚ç›£æ§ - {{ super() }}{% endblock %}

{% block head %}
<style>
    .monitor-container {
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .meter-selector {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .control-panel {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .monitor-table {
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 16px;
    }
    
    .monitor-table table {
        width: 100%;
        margin: 0;
        font-family: 'Courier New', monospace;
        font-size: 12px;
    }
    
    .monitor-table th {
        background: var(--primary-color);
        color: white;
        padding: 10px 8px;
        text-align: center;
        font-weight: bold;
        border: none;
    }
    
    .monitor-table td {
        padding: 8px;
        text-align: center;  
        border-bottom: 1px solid var(--border-color);
        background: var(--background-color);
    }
    
    .monitor-table tbody tr:nth-child(even) td {
        background: var(--surface-color);
    }
    
    .monitor-table tbody tr:hover td {
        background: rgba(var(--primary-color-rgb), 0.1);
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
    }
    
    .status-monitoring {
        background-color: var(--success-color);
        color: white;
    }
    
    .status-stopped {
        background-color: var(--error-color);
        color: white;
    }
    
    .status-connecting {
        background-color: var(--warning-color);
        color: white;
    }
    
    .relay-status {
        font-weight: bold;
    }
    
    .relay-on {
        color: var(--success-color);
    }
    
    .relay-off {
        color: var(--error-color);
    }
    
    .relay-unknown {
        color: var(--text-secondary);
    }
    
    .data-cell {
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }
    
    .change-positive {
        color: var(--success-color);
    }
    
    .change-negative {
        color: var(--error-color);
    }
    
    .monitor-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .btn-group .btn {
        margin-right: 5px;
    }
    
    .btn-group .btn:last-child {
        margin-right: 0;
    }
    
    .meter-select {
        min-width: 200px;
    }
    
    .interval-input {
        width: 80px;
    }
    
    .alert {
        margin-bottom: 16px;
    }
    
    .table-container {
        max-height: 60vh;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }
    
    .monitor-header {
        background: var(--primary-color);
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        margin: -20px -20px 20px -20px;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="monitor-container">
    <div class="monitor-header">
        <h4 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>
            é›»è¡¨å³æ™‚ç›£æ§ç³»çµ±
        </h4>
        <small>é¸æ“‡ä»»æ„é›»è¡¨é€²è¡Œå³æ™‚ç›£æ§èˆ‡ç¹¼é›»å™¨æ§åˆ¶</small>
    </div>
    
    <!-- ç›£æ§çµ±è¨ˆ -->
    <div class="monitor-stats">
        <div class="stat-card">
            <div class="stat-value" id="monitorStatus">æœªç›£æ§</div>
            <div class="stat-label">ç›£æ§ç‹€æ…‹</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="currentMeter">--</div>
            <div class="stat-label">ç•¶å‰é›»è¡¨</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="monitorDuration">--</div>
            <div class="stat-label">ç›£æ§æ™‚é•·</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalChange">--</div>
            <div class="stat-label">ç´¯è¨ˆè®ŠåŒ– (kWh)</div>
        </div>
    </div>
    
    <!-- é›»è¡¨é¸æ“‡å€ -->
    <div class="meter-selector">
        <label for="meterSelect" class="form-label mb-0">
            <i class="fas fa-bolt me-1"></i>é¸æ“‡é›»è¡¨ï¼š
        </label>
        <select id="meterSelect" class="form-select meter-select">
            <option value="">è«‹é¸æ“‡é›»è¡¨...</option>
        </select>
        
        <div class="btn-group">
            <button id="startMonitor" class="btn btn-success" disabled>
                <i class="fas fa-play me-1"></i>é–‹å§‹ç›£æ§
            </button>
            <button id="stopMonitor" class="btn btn-danger" disabled>
                <i class="fas fa-stop me-1"></i>åœæ­¢ç›£æ§
            </button>
        </div>
        
        <button id="testConnection" class="btn btn-info" disabled>
            <i class="fas fa-plug me-1"></i>æ¸¬è©¦é€£æ¥
        </button>
    </div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <label for="intervalInput" class="form-label mb-0">
            <i class="fas fa-clock me-1"></i>ç›£æ§é–“éš”ï¼š
        </label>
        <input type="number" id="intervalInput" class="form-control interval-input" 
               value="5" min="1" max="60"> ç§’
        
        <div class="btn-group">
            <button id="relayOn" class="btn btn-warning" disabled>
                <i class="fas fa-power-off me-1"></i>RELAY ON
            </button>
            <button id="relayOff" class="btn btn-secondary" disabled>
                <i class="fas fa-power-off me-1"></i>RELAY OFF
            </button>
        </div>
        
        <span>ç•¶å‰ç‹€æ…‹ï¼š
            <span id="relayStatus" class="badge bg-secondary relay-status">æœªçŸ¥</span>
        </span>
        
        <button id="clearData" class="btn btn-outline-danger">
            <i class="fas fa-trash me-1"></i>æ¸…é™¤æ•¸æ“š
        </button>
    </div>
    
    <!-- è­¦å‘Š/ç‹€æ…‹æ¶ˆæ¯ -->
    <div id="alertContainer"></div>
    
    <!-- ç›£æ§æ•¸æ“šè¡¨æ ¼ -->
    <div class="table-container">
        <table class="table table-striped table-hover mb-0">
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>é›»å£“(V)</th>
                    <th>é›»æµ(A)</th>
                    <th>åŠŸç‡(W)</th>
                    <th>é›»èƒ½(kWh)</th>
                    <th>è®ŠåŒ–(kWh)</th>
                    <th>ç´¯è¨ˆè®ŠåŒ–</th>
                    <th>ç¹¼é›»å™¨</th>
                </tr>
            </thead>
            <tbody id="monitorData">
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle me-2"></i>
                        è«‹é¸æ“‡é›»è¡¨ä¸¦é–‹å§‹ç›£æ§ä»¥æŸ¥çœ‹å³æ™‚æ•¸æ“š
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- ç›£æ§èªªæ˜ -->
    <div class="mt-3">
        <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            <strong>ä½¿ç”¨èªªæ˜ï¼š</strong>
            1. é¸æ“‡è¦ç›£æ§çš„é›»è¡¨ (1-50)
            2. è¨­å®šç›£æ§é–“éš” (1-60ç§’)
            3. é»æ“Šã€Œé–‹å§‹ç›£æ§ã€é–‹å§‹å³æ™‚ç›£æ§
            4. å¯éš¨æ™‚æ§åˆ¶è©²é›»è¡¨çš„ç¹¼é›»å™¨ ON/OFF
            5. ç›£æ§æ•¸æ“šæœƒå³æ™‚æ›´æ–°ä¸¦é¡¯ç¤ºè®ŠåŒ–é‡
        </small>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/monitor.js') }}"></script>
<script>
// é¡å¤–çš„èª¿è©¦ä»£ç¢¼
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”§ Monitoré é¢èª¿è©¦ä¿¡æ¯');
    
    // æª¢æŸ¥é›»è¡¨é¸æ“‡å™¨
    const meterSelect = document.getElementById('meterSelect');
    console.log('é›»è¡¨é¸æ“‡å™¨å…ƒç´ :', meterSelect);
    
    // æ¸¬è©¦APIé€£æ¥
    setTimeout(async () => {
        try {
            console.log('ğŸ”— æ¸¬è©¦APIé€£æ¥...');
            const response = await fetch('/api/monitor/meters');
            const result = await response.json();
            console.log('APIå›æ‡‰:', result);
            
            if (result.success && result.data) {
                console.log(`âœ… APIæ­£å¸¸ï¼Œè¿”å›${result.data.length}å€‹é›»è¡¨`);
                
                // æ‰‹å‹•å¡«å……é¸æ“‡å™¨ï¼ˆå¦‚æœè‡ªå‹•å¡«å……å¤±æ•—ï¼‰
                if (meterSelect && meterSelect.options.length <= 1) {
                    console.log('ğŸ› ï¸ æ‰‹å‹•å¡«å……é›»è¡¨é¸é …');
                    result.data.forEach(meter => {
                        const option = document.createElement('option');
                        option.value = meter.id;
                        option.textContent = meter.display_name;
                        meterSelect.appendChild(option);
                    });
                    console.log(`âœ… æ‰‹å‹•æ·»åŠ äº†${result.data.length}å€‹é›»è¡¨é¸é …`);
                    
                    // é€šçŸ¥ MeterMonitor å¯¦ä¾‹æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    if (window.meterMonitor) {
                        console.log('ğŸ”§ æ‰‹å‹•è§¸ç™¼æŒ‰éˆ•ç‹€æ…‹æ›´æ–°');
                        window.meterMonitor.updateButtonStates(false);
                    } else {
                        console.log('âš ï¸ window.meterMonitor å°šæœªåˆå§‹åŒ–ï¼Œç­‰å¾…åˆå§‹åŒ–...');
                        // å»¶é²é‡è©¦
                        setTimeout(() => {
                            if (window.meterMonitor) {
                                console.log('ğŸ”§ å»¶é²è§¸ç™¼æŒ‰éˆ•ç‹€æ…‹æ›´æ–°');
                                window.meterMonitor.updateButtonStates(false);
                            } else {
                                console.error('âŒ MeterMonitor åˆå§‹åŒ–å¤±æ•—');
                            }
                        }, 1000);
                    }
                }
            } else {
                console.error('âŒ APIå›æ‡‰ç•°å¸¸:', result);
            }
        } catch (error) {
            console.error('âŒ APIé€£æ¥å¤±æ•—:', error);
        }
    }, 2000);
});
</script>
{% endblock %}